def calc_equity_curve(initial_capital,trade_returns):
    equity=initial_capital
    equity_curve=[equity]
    for r in trade_returns:
        equity=equity*(1+r)
        equity_curve.append(equity)
    return equity_curve
def calc_max_drawndown(equity_curve):
    max_peak=equity_curve[0]
    max_dd=0.0
    for eq in equity_curve:
        if eq>max_peak:
            max_peak=eq
        dd=eq/max_peak-1
        if dd<max_dd:
            max_dd=dd
    return max_dd
#示例价格
prices=[100,102,111,112,115,117]

ma_window=3 #3日均线
initial_capital=1000.0#初始资金
#计算每一根k的收益率
bar_returns=[]#从第一根开始
for i in range(1,len(prices)):
    r=prices[i]/prices[i-1]-1
    bar_returns.append(r)
#计算 每一根k线的均线值 前几根不够窗口的用 None 填
ma_list=[]
for i in range(len(prices)):
    if i<ma_window-1:
        ma_list.append(None)
    else:
        window=prices[i-ma_window+1:i+1]
        #计算均值
        ma=sum(window)/ma_window
        #存入结果
        ma_list.append(ma)
#按照price vs ma 决定持仓(0=持仓 1=做多)
positions=[]
for i in range(len(prices)):
    if ma_list[i] is None:
        positions.append(0)#前几根无均线 不交易
    else:
        if prices[i]>ma_list[i]:
            positions.append(1)#out
        else:
            positions.append(0) #in
#根据仓位，生成策略的每根收益率
strategy_returns=[]

#bar_returns 从“第一根->第二根”开始的
# 我们用 “前一根K的持仓” 来参与当前这段收益，避免用到未来数据
for i in range(len(bar_returns)):
    pos_prev=positions[i]   #第i根k的仓位
    r=bar_returns[i]    #第i->i+1这段的涨跌
    strategy_returns.append(pos_prev*r)

#6. 用你写好的函数算资金曲线和最大回撤
strategy_equity=calc_equity_curve(initial_capital,strategy_returns)
buy_hold_equity=calc_equity_curve(initial_capital,bar_returns)

strategy_final=strategy_equity[-1]
buy_hold_fianl=buy_hold_equity[-1]

strategy_total_return=strategy_final/initial_capital-1
buy_hold_total_return=buy_hold_fianl/initial_capital-1

strategy_max_dd=calc_max_drawndown(strategy_equity)
buy_hold_max_dd=calc_max_drawndown(buy_hold_equity)

#打印结果
print("价格列表:",prices)
print("均线列表:",[f"{x:.2f}"if x is not None else None
                for x in ma_list])
print("持仓列表:",positions)
print("资金曲线(策略):",[f"{x:.2f}"for x in strategy_equity])
print("资金曲线(买入持有):",[f"{x:.2f}"for x in buy_hold_equity])

print("-"*50)
print(f"策略最终资金:{strategy_final:.2f}USD,总收益率：{strategy_total_return:.2%},最大回撤:{strategy_max_dd:.2%}")
print(f"买入持有最终资金: {buy_hold_fianl:.2f} USD, 总收益率: {buy_hold_total_return:.2%}, 最大回撤: {buy_hold_max_dd:.2%}")
                                  

        






